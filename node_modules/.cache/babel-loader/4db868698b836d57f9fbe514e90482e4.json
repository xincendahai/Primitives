{"ast":null,"code":"import _createForOfIteratorHelper from \"/Users/xiangmingxin/Wicrecend/\\u56FE\\u5143/react-visual-data/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createForOfIteratorHelper\";\nimport _slicedToArray from \"/Users/xiangmingxin/Wicrecend/\\u56FE\\u5143/react-visual-data/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";\nimport _defineProperty from \"/Users/xiangmingxin/Wicrecend/\\u56FE\\u5143/react-visual-data/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/defineProperty\";\nimport _objectWithoutProperties from \"/Users/xiangmingxin/Wicrecend/\\u56FE\\u5143/react-visual-data/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/objectWithoutProperties\";\nvar _jsxFileName = \"/Users/xiangmingxin/Wicrecend/\\u56FE\\u5143/react-visual-data/src/library/renderer/core/grid.jsx\";\n\n/**\n * 基于react-grid-layout的核心拖拽方案\n */\nimport React, { useState, useEffect, memo, useMemo, useCallback } from \"react\";\nimport cx from \"classnames\";\nimport { WidthProvider, Responsive } from \"react-grid-layout\";\nimport { connect } from \"react-redux\";\nimport { getField } from \"~materials\";\nimport { useTools } from \"~common/hooks\";\nimport { mergeFieldConfig, setLevelPath } from \"../utils\";\nimport { throttle } from \"~utils\";\nimport generator from \"../generator\";\nimport \"react-grid-layout/css/styles.css\";\nimport \"react-resizable/css/styles.css\";\nvar ResponsiveGridLayout = WidthProvider(Responsive); // TODO：ui和组件拔插模式\n\nfunction GeneratorField(_ref) {\n  var _cx;\n\n  var _ref$value = _ref.value,\n      value = _ref$value === void 0 ? {} : _ref$value,\n      _ref$onValueChange = _ref.onValueChange,\n      onValueChange = _ref$onValueChange === void 0 ? function () {} : _ref$onValueChange,\n      activeKey = _ref.activeKey,\n      dispatch = _ref.dispatch;\n\n  var _value$data = value.data,\n      title = _value$data.title,\n      hideTitle = _value$data.hideTitle,\n      titleAlign = _value$data.titleAlign,\n      titleColor = _value$data.titleColor,\n      background = _value$data.background,\n      rest = _objectWithoutProperties(_value$data, [\"title\", \"hideTitle\", \"titleAlign\", \"titleColor\", \"background\"]);\n\n  var classNames = cx(\"gc-field-grid animate__animated\", (_cx = {}, _defineProperty(_cx, \"animate__\".concat(rest.animateType), rest.animateType), _defineProperty(_cx, \"animate__\".concat(rest.animateSpeed), rest.animateSpeed), _defineProperty(_cx, \"animate__\".concat(rest.animateRepeat), rest.animateRepeat), _defineProperty(_cx, \"animate__delay-\".concat(rest.animateTime, \"s\"), rest.animateTime), _cx));\n  var isSelect = useMemo(function () {\n    return activeKey === value.uniqueId;\n  }, [activeKey]);\n\n  var handleClick = function handleClick(e) {\n    e.stopPropagation();\n    if (isSelect) return;\n    dispatch({\n      type: \"component/fieldType\",\n      data: \"component\"\n    }); // TODO: 获取当前用户点击的key\n\n    dispatch({\n      type: \"component/activeKey\",\n      data: value.uniqueId\n    });\n  };\n\n  var overwriteStyle = {\n    borderWidth: 2,\n    borderStyle: \"solid\",\n    borderColor: isSelect ? \"#2681ff\" : \"transparent\",\n    background: background,\n    boxShadow: rest.shadowColor ? \"\".concat(rest.shadowColor, \" \").concat(rest.shadowWidth || 0, \" \").concat(rest.shadowOffset || 0, \" \").concat(rest.shadowOffset || 0) : rest.shadowWidth\n  };\n  var getSubField = useCallback(function (m) {\n    var prop = getField(value.type);\n    return generator(prop)(m);\n  }, [value.type]);\n  var fieldProps = useMemo(function () {\n    return {\n      value: value.data,\n      type: value.type,\n      uniqueId: value.uniqueId,\n      options: value.data.config || {},\n      onChange: function onChange(val) {\n        var level = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : 1;\n        onValueChange && onValueChange(value.uniqueId, val, level);\n      }\n    };\n  }, [isSelect, value.data, onValueChange]);\n  return /*#__PURE__*/React.createElement(\"div\", {\n    className: classNames,\n    style: overwriteStyle,\n    onClick: handleClick,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 74,\n      columnNumber: 5\n    }\n  }, !hideTitle ? /*#__PURE__*/React.createElement(\"div\", {\n    className: \"grid-hd\",\n    style: {\n      color: titleColor,\n      textAlign: titleAlign\n    },\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 76,\n      columnNumber: 9\n    }\n  }, title) : null, /*#__PURE__*/React.createElement(\"div\", {\n    className: \"grid-bd\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 86,\n      columnNumber: 7\n    }\n  }, getSubField(fieldProps)));\n}\n\nfunction GridRenderer(_ref2) {\n  var _this = this;\n\n  var dataGrid = _ref2.dataGrid,\n      activeKey = _ref2.activeKey,\n      conditions = _ref2.conditions,\n      dispatch = _ref2.dispatch;\n\n  var _useTools = useTools(),\n      setState = _useTools.setState;\n\n  var _useState = useState({}),\n      _useState2 = _slicedToArray(_useState, 2),\n      layouts = _useState2[0],\n      setLayouts = _useState2[1];\n\n  var _useState3 = useState(false),\n      _useState4 = _slicedToArray(_useState3, 2),\n      flag = _useState4[0],\n      setFlag = _useState4[1];\n\n  useEffect(function () {\n    // setFlag(true);\n    var generateLayouts = dataGrid.map(function (item) {\n      return {\n        i: item.uniqueId,\n        x: item.data.left,\n        y: item.data.top || Infinity,\n        // puts it at the bottom\n        w: item.data.width || 4,\n        h: item.data.height || 25\n      };\n    });\n    setLayouts({\n      lg: generateLayouts,\n      sm: generateLayouts\n    });\n  }, [dataGrid]);\n\n  var onDragHandle = function onDragHandle(layout, oldItem, newItem, placeholder, e) {\n    // TODO: fix拖拽和点击事件冲突\n    if (layout.some(function (o) {\n      return o.i === oldItem.i;\n    })) return;\n    e.preventDefault();\n    e.stopPropagation();\n  };\n\n  function onLayoutChange(layout) {\n    if (!flag) {\n      return;\n    }\n\n    var results;\n\n    var _iterator = _createForOfIteratorHelper(layout),\n        _step;\n\n    try {\n      for (_iterator.s(); !(_step = _iterator.n()).done;) {\n        var o = _step.value;\n        results = mergeFieldConfig(dataGrid, {\n          parentId: o.i\n        }, {\n          width: o.w,\n          height: o.h,\n          left: o.x,\n          top: o.y\n        });\n      } // TODO: 处理过滤条件数据\n\n    } catch (err) {\n      _iterator.e(err);\n    } finally {\n      _iterator.f();\n    }\n\n    throttle(setState({\n      components: results\n    }), 500);\n  }\n\n  var onValueChange = function onValueChange(uniqueId, value) {\n    var level = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : 0;\n    setLevelPath(dataGrid, null);\n    var results = mergeFieldConfig(dataGrid, {\n      parentId: uniqueId,\n      level: level\n    }, value);\n    setState({\n      components: results\n    });\n  };\n\n  if (dataGrid.length === 0) return null;\n  return /*#__PURE__*/React.createElement(ResponsiveGridLayout, {\n    width: 1200,\n    breakpoints: {\n      lg: 1200,\n      md: 996,\n      sm: 768,\n      xs: 480,\n      xxs: 0\n    },\n    cols: {\n      lg: 12,\n      md: 12,\n      sm: 12,\n      xs: 4,\n      xxs: 2\n    },\n    rowHeight: 0,\n    isResizable: true,\n    isDraggable: true,\n    layouts: layouts,\n    containerPadding: [0, 0],\n    useCSSTransforms: false,\n    onDragStart: onDragHandle,\n    onLayoutChange: onLayoutChange,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 145,\n      columnNumber: 5\n    }\n  }, dataGrid.map(function (item) {\n    return /*#__PURE__*/React.createElement(\"div\", {\n      key: item.uniqueId,\n      __self: _this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 159,\n        columnNumber: 9\n      }\n    }, !item.data.isHidden ? /*#__PURE__*/React.createElement(GeneratorField, {\n      value: item,\n      key: item.uniqueId,\n      activeKey: activeKey,\n      dispatch: dispatch,\n      onValueChange: onValueChange,\n      __self: _this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 161,\n        columnNumber: 13\n      }\n    }) : null);\n  }));\n}\n\nexport default connect(function (state) {\n  return {\n    activeKey: state.component.activeKey,\n    conditions: state.form.conditions\n  };\n})(memo(GridRenderer));","map":{"version":3,"sources":["/Users/xiangmingxin/Wicrecend/图元/react-visual-data/src/library/renderer/core/grid.jsx"],"names":["React","useState","useEffect","memo","useMemo","useCallback","cx","WidthProvider","Responsive","connect","getField","useTools","mergeFieldConfig","setLevelPath","throttle","generator","ResponsiveGridLayout","GeneratorField","value","onValueChange","activeKey","dispatch","data","title","hideTitle","titleAlign","titleColor","background","rest","classNames","animateType","animateSpeed","animateRepeat","animateTime","isSelect","uniqueId","handleClick","e","stopPropagation","type","overwriteStyle","borderWidth","borderStyle","borderColor","boxShadow","shadowColor","shadowWidth","shadowOffset","getSubField","m","prop","fieldProps","options","config","onChange","val","level","color","textAlign","GridRenderer","dataGrid","conditions","setState","layouts","setLayouts","flag","setFlag","generateLayouts","map","item","i","x","left","y","top","Infinity","w","width","h","height","lg","sm","onDragHandle","layout","oldItem","newItem","placeholder","some","o","preventDefault","onLayoutChange","results","parentId","components","length","md","xs","xxs","isHidden","state","component","form"],"mappings":"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","sourcesContent":["/**\n * 基于react-grid-layout的核心拖拽方案\n */\nimport React, { useState, useEffect, memo, useMemo, useCallback } from \"react\";\nimport cx from \"classnames\";\nimport { WidthProvider, Responsive } from \"react-grid-layout\";\nimport { connect } from \"react-redux\";\nimport { getField } from \"~materials\";\nimport { useTools } from \"~common/hooks\";\nimport { mergeFieldConfig, setLevelPath } from \"../utils\";\nimport { throttle } from \"~utils\";\nimport generator from \"../generator\";\nimport \"react-grid-layout/css/styles.css\";\nimport \"react-resizable/css/styles.css\";\n\nconst ResponsiveGridLayout = WidthProvider(Responsive);\n\n// TODO：ui和组件拔插模式\nfunction GeneratorField({ value = {}, onValueChange = () => {}, activeKey, dispatch }) {\n  const { title, hideTitle, titleAlign, titleColor, background, ...rest } = value.data;\n\n  const classNames = cx(\"gc-field-grid animate__animated\", {\n    [`animate__${rest.animateType}`]: rest.animateType,\n    [`animate__${rest.animateSpeed}`]: rest.animateSpeed,\n    [`animate__${rest.animateRepeat}`]: rest.animateRepeat,\n    [`animate__delay-${rest.animateTime}s`]: rest.animateTime\n  });\n\n  const isSelect = useMemo(() => {\n    return activeKey === value.uniqueId;\n  }, [activeKey]);\n\n  const handleClick = (e) => {\n    e.stopPropagation();\n    if (isSelect) return;\n\n    dispatch({ type: \"component/fieldType\", data: \"component\" });\n    // TODO: 获取当前用户点击的key\n    dispatch({ type: \"component/activeKey\", data: value.uniqueId });\n  };\n\n  const overwriteStyle = {\n    borderWidth: 2,\n    borderStyle: \"solid\",\n    borderColor: isSelect ? \"#2681ff\" : \"transparent\",\n    background,\n    boxShadow: rest.shadowColor\n      ? `${rest.shadowColor} ${rest.shadowWidth || 0} ${rest.shadowOffset || 0} ${rest.shadowOffset || 0}`\n      : rest.shadowWidth\n  };\n\n  const getSubField = useCallback(\n    (m) => {\n      const prop = getField(value.type);\n      return generator(prop)(m);\n    },\n    [value.type]\n  );\n\n  const fieldProps = useMemo(\n    () => ({\n      value: value.data,\n      type: value.type,\n      uniqueId: value.uniqueId,\n      options: value.data.config || {},\n      onChange: (val, level = 1) => {\n        onValueChange && onValueChange(value.uniqueId, val, level);\n      }\n    }),\n    [isSelect, value.data, onValueChange]\n  );\n\n  return (\n    <div className={classNames} style={overwriteStyle} onClick={handleClick}>\n      {!hideTitle ? (\n        <div\n          className=\"grid-hd\"\n          style={{\n            color: titleColor,\n            textAlign: titleAlign\n          }}\n        >\n          {title}\n        </div>\n      ) : null}\n      <div className=\"grid-bd\">{getSubField(fieldProps)}</div>\n    </div>\n  );\n}\n\nfunction GridRenderer({ dataGrid, activeKey, conditions, dispatch }) {\n  const { setState } = useTools();\n  const [layouts, setLayouts] = useState({});\n  const [flag, setFlag] = useState(false);\n\n  useEffect(() => {\n    // setFlag(true);\n    const generateLayouts = dataGrid.map((item) => ({\n      i: item.uniqueId,\n      x: item.data.left,\n      y: item.data.top || Infinity, // puts it at the bottom\n      w: item.data.width || 4,\n      h: item.data.height || 25\n    }));\n    setLayouts({ lg: generateLayouts, sm: generateLayouts });\n  }, [dataGrid]);\n\n  const onDragHandle = (layout, oldItem, newItem, placeholder, e) => {\n    // TODO: fix拖拽和点击事件冲突\n    if (layout.some((o) => o.i === oldItem.i)) return;\n    e.preventDefault();\n    e.stopPropagation();\n  };\n\n  function onLayoutChange(layout) {\n    if (!flag) {\n      return;\n    }\n    let results;\n    for (const o of layout) {\n      results = mergeFieldConfig(\n        dataGrid,\n        { parentId: o.i },\n        {\n          width: o.w,\n          height: o.h,\n          left: o.x,\n          top: o.y\n        }\n      );\n    }\n    // TODO: 处理过滤条件数据\n    throttle(setState({ components: results }), 500);\n  }\n\n  const onValueChange = (uniqueId, value, level = 0) => {\n    setLevelPath(dataGrid, null);\n    let results = mergeFieldConfig(dataGrid, { parentId: uniqueId, level: level }, value);\n    setState({ components: results });\n  };\n\n  if (dataGrid.length === 0) return null;\n\n  return (\n    <ResponsiveGridLayout\n      width={1200}\n      breakpoints={{ lg: 1200, md: 996, sm: 768, xs: 480, xxs: 0 }}\n      cols={{ lg: 12, md: 12, sm: 12, xs: 4, xxs: 2 }}\n      rowHeight={0}\n      isResizable={true}\n      isDraggable={true}\n      layouts={layouts}\n      containerPadding={[0, 0]}\n      useCSSTransforms={false}\n      onDragStart={onDragHandle}\n      onLayoutChange={onLayoutChange}\n    >\n      {dataGrid.map((item) => (\n        <div key={item.uniqueId}>\n          {!item.data.isHidden ? (\n            <GeneratorField\n              value={item}\n              key={item.uniqueId}\n              activeKey={activeKey}\n              dispatch={dispatch}\n              onValueChange={onValueChange}\n            />\n          ) : null}\n        </div>\n      ))}\n    </ResponsiveGridLayout>\n  );\n}\n\nexport default connect((state) => ({\n  activeKey: state.component.activeKey,\n  conditions: state.form.conditions\n}))(memo(GridRenderer));\n"]},"metadata":{},"sourceType":"module"}